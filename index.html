<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Testing Platform Games</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
      color: #333;
    }

    header, footer {
      background-color: #222;
      color: white;
      padding: 1em;
      text-align: center;
    }

    h1, h2 {
      margin-top: 1em;
    }

    .container {
      display: flex;
      flex-wrap: wrap;
      padding: 1em;
    }

    nav {
      flex: 1 1 200px;
      background-color: #eee;
      padding: 1em;
      border-right: 2px solid #ccc;
    }

    main {
      flex: 4 1 600px;
      padding: 1em;
    }

    ul {
      list-style-type: none;
      padding-left: 0;
    }

    li {
      margin: 0.5em 0;
    }

    a {
      color: #0077cc;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .category {
      background-color: white;
      border: 1px solid #ccc;
      margin-bottom: 1em;
      padding: 1em;
      border-radius: 8px;
    }

    .genre-title {
      margin: 0 0 0.5em 0;
      font-size: 1.1em;
      font-weight: 700;
    }

    /* Install button styled to look like a link */
    .install-link {
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      color: #0077cc;
      cursor: pointer;
      font: inherit;
      text-align: left;
    }
    .install-link:hover {
      text-decoration: underline;
    }

    /* disabled / already installed style */
    .install-disabled {
      color: #888;
      text-decoration: none;
      cursor: default;
      pointer-events: none;
    }

    @media screen and (max-width: 768px) {
      .container {
        flex-direction: column;
      }

      nav {
        border-right: none;
        border-bottom: 2px solid #ccc;
      }
    }
  </style>
  <script>
    // Register the service worker if available
    if ('serviceWorker' in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register('service-worker.js').then(() => {
          console.log('ServiceWorker registered');
        }).catch((err) => {
          console.log('ServiceWorker error: ', err);
        });
      });
    }
  </script>
</head>
<body>

<header>
  <h1>Testing Platform Games</h1>
  <p><em>"Games for the ones that don't get support for any!"</em></p>
</header>

<div class="container">
  <nav>
    <h3>Browse by genre</h3>
    <ul>
      <li><a href="#strategy">Strategy / Tower Defense</a></li>
      <li><a href="#adventure">Adventure</a></li>
      <li><a href="#platformer">Platformer</a></li>
      <li><a href="#arcade">Arcade</a></li>
      <li><a href="#puzzle">Puzzle</a></li>
      <li><a href="#racing">Racing</a></li>
      <li><a href="#sandbox">Sandbox / Simulation</a></li>
      <li><a href="#shooter">Shooter / FPS</a></li>
      <li><a href="#originals">Original Games</a></li>
    </ul>

    <h3 style="margin-top:1em">Quick Links</h3>
    <ul>
      <li><a href="/credits.html">Credits</a></li>
      <li><a href="https://github.com/testing-platform-games/testing-platform-games.github.io">GitHub Repository</a></li>
      <li><a href="https://github.com/testing-platform-games/testing-platform-games.github.io/issues/new/choose">Game Request and Report Issue</a></li>
      <li><a href="https://cash.app/$SebbyWebby12345">Donate</a></li>
      <!-- Install PWA option -->
      <li><button id="install-btn" class="install-link" style="display:none" aria-live="polite">Install PWA</button></li>
    </ul>
  </nav>

  <main>
    <section id="strategy" class="category">
      <h2 class="genre-title">Strategy / Tower Defense</h2>
      <ul>
        <li><a href="/games/bloonstd.html">Bloons TD</a></li>
        <li><a href="/games/bloonstd2.html">Bloons TD 2</a></li>
        <li><a href="/games/bloonstd3.html">Bloons TD 3</a></li>
        <li><a href="/games/bloonstd4.html">Bloons TD 4</a></li>
        <li><a href="/games/bloonstd4exp.html">Bloons TD 4 Expansion</a></li>
        <li><a href="/games/bloonstd5.html">Bloons TD 5</a></li>
      </ul>
    </section>

    <section id="adventure" class="category">
      <h2 class="genre-title">Adventure</h2>
      <ul>
        <li><a href="/games/breaking-the-bank.html">Breaking the Bank</a></li>
        <li><a href="/games/crossing-the-pit.html">Crossing the Pit</a></li>
        <li><a href="/games/crystal-seeker-3d.html">Crystal Seeker 3D</a></li>
        <li><a href="/games/escaping-the-prison.html">Escaping the Prison</a></li>
        <li><a href="/games/fleeing-the-complex.html">Fleeing the Complex</a></li>
        <li><a href="/games/infiltrating-the-airship.html">Infiltrating the Airship</a></li>
        <li><a href="/games/mission-in-snowdriftland/">Mission in Snowdriftland</a></li>
        <li><a href="/games/poke-dp-shareware-demo.html">Pokemon DP (Demo)</a></li>
        <li><a href="/games/stealing-the-diamond.html">Stealing the Diamond</a></li>
      </ul>
    </section>

    <section id="platformer" class="category">
      <h2 class="genre-title">Platformer</h2>
      <ul>
        <li><a href="/games/srbtweb.html">Sonic Robo Blast 2</a></li>
        <li><a href="/games/super-mario-63.html">Super Mario 63</a></li>
      </ul>
    </section>

    <section id="arcade" class="category">
      <h2 class="genre-title">Arcade</h2>
      <ul>
        <li><a href="/games/flappy-bird/">Flappy Bird</a></li>
        <li><a href="/games/qwop.html">QWOP</a></li>
        <li><a href="/games/slope-y8.html">Slope (Y8)</a></li>
        <li><a href="/games/sprinter.html">Sprinter</a></li>
      </ul>
    </section>

    <section id="puzzle" class="category">
      <h2 class="genre-title">Puzzle</h2>
      <ul>
        <li><a href="/games/bloxors.html">Bloxors</a></li>
        <li><a href="/games/tetris.html">Tetris (Gameboy)</a></li>
      </ul>
    </section>

    <section id="racing" class="category">
      <h2 class="genre-title">Racing</h2>
      <ul>
        <li><a href="/games/mkdsdemo.html">Mario Kart DS Demo</a></li>
        <li><a href="/games/moto-x3m.html">Moto X3M</a></li>
      </ul>
    </section>

    <section id="sandbox" class="category">
      <h2 class="genre-title">Sandbox / Simulation</h2>
      <ul>
        <li><a href="/games/classicmc.html">Classic Minecraft</a></li>
        <li><a href="/games/paper-mc.html">Paper Minecraft</a></li>
      </ul>
    </section>

    <section id="shooter" class="category">
      <h2 class="genre-title">Shooter / FPS</h2>
      <ul>
        <li><a href="/games/chex.html">Chex Quest</a></li>
        <li><a href="/games/chex2.html">Chex Quest 2</a></li>
        <li><a href="/games/doom-shareware.html">DOOM (Shareware)</a></li>
        <li><a href="/games/duke3d-shareware.html">Duke Nukem 3D (Shareware)</a></li>
        <li><a href="/games/freedoom1.html">FreeDOOM Phase 1</a></li>
        <li><a href="/games/freedoom2.html">FreeDOOM Phase 2</a></li>
        <li><a href="/games/nzp-web.html">Nazi Zombies: Portable</a></li>
        <li><a href="/games/quake-shareware.html">Quake (Separate Game files required)</a></li>
        <li><a href="/games/wolf3d-advisary-warning.html">Wolfenstein 3D (Shareware)</a></li>
        <li><a href="/games/yadc.html">Yet Another Doom Clone</a></li>
      </ul>
    </section>

    <section id="originals" class="category">
      <h2 class="genre-title">Original Games</h2>
      <p>Coming Soon! (Or never, depends)</p>
    </section>
  </main>
</div>

<footer>
  <p>&copy; 2025 Testing Platform Games</p>
</footer>

<script>
  // PWA installation prompt handling, installed detection and auto-launch attempt.
  (function () {
    let deferredPrompt = null;

    // Helper: Detect if the current context is the PWA (standalone mode)
    function isRunningInStandalone() {
      // Standard display-mode check
      if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) return true;
      // iOS
      if (window.navigator.standalone === true) return true;
      return false;
    }

    // Helper: best-effort detection whether the app is installed
    async function isAppInstalled() {
      // 1) If browser supports getInstalledRelatedApps and the manifest declares related apps, use it
      if ('getInstalledRelatedApps' in navigator) {
        try {
          const related = await navigator.getInstalledRelatedApps();
          if (related && related.length > 0) return true;
        } catch (err) {
          // ignore
        }
      }
      // 2) Check localStorage flag set when appinstalled fires (persisted after install)
      try {
        if (localStorage.getItem('pwa_installed') === 'true') return true;
      } catch (err) {
        // ignore private mode localStorage failures
      }
      // 3) No reliable global API exists across all platforms — return false if unknown
      return false;
    }

    // Try to get start_url from manifest (fallback to '/')
    async function getManifestStartURL() {
      try {
        const resp = await fetch('manifest.json', {cache: 'no-cache'});
        if (!resp.ok) return '/';
        const manifest = await resp.json();
        const start = manifest.start_url || '/';
        // Resolve relative URLs against current origin
        return new URL(start, location.href).href;
      } catch (err) {
        return '/';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const installBtn = document.getElementById('install-btn');
      if (!installBtn) return;

      // Hide by default; it will be shown on beforeinstallprompt or when installable
      installBtn.style.display = 'none';

      // Listen for beforeinstallprompt and show install button
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBtn.style.display = 'inline';
        installBtn.classList.remove('install-disabled');
        installBtn.disabled = false;
        installBtn.textContent = 'Install PWA';
      });

      // Handle clicks on the install button
      installBtn.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const choice = await deferredPrompt.userChoice;
        console.log('PWA install outcome:', choice.outcome);
        deferredPrompt = null;
        installBtn.style.display = 'none';
      });

      // When PWA is installed, the browser fires this event: store a persistent flag
      window.addEventListener('appinstalled', () => {
        console.log('PWA was installed');
        try {
          localStorage.setItem('pwa_installed', 'true');
        } catch (err) { /* ignore */ }
        // Update UI if install button exists
        if (installBtn) {
          installBtn.textContent = 'Already installed';
          installBtn.classList.add('install-disabled');
          installBtn.disabled = true;
        }
      });

      // On page load, check if app is installed and not running as standalone.
      (async () => {
        const installed = await isAppInstalled();
        const standalone = isRunningInStandalone();

        if (installed) {
          // If installed and user is not running the PWA, try to auto-open the PWA and grey out the option
          if (!standalone) {
            // Grey out the install option
            installBtn.style.display = 'inline';
            installBtn.textContent = 'Already installed';
            installBtn.classList.add('install-disabled');
            installBtn.disabled = true;

            // Attempt to open the installed PWA by navigating to its start_url.
            // Note: There is no standard JS API to "launch" an installed PWA from a regular browser tab.
            // Best-effort: navigate to the manifest's start_url — on some platforms this will open the installed app
            // (behavior depends on OS / browser settings). This is a pragmatic attempt, not a guaranteed method.
            try {
              const startUrl = await getManifestStartURL();
              console.log('Attempting to open installed PWA via start_url:', startUrl);
              // small delay so the UI update (Already installed) is visible before navigation
              setTimeout(() => {
                // use location.href to navigate in same tab; on some platforms this may open in the installed app
                window.location.href = startUrl;
              }, 300);
            } catch (err) {
              console.warn('Failed to auto-open PWA:', err);
            }
            return;
          } else {
            // Already running in PWA — hide the install button entirely
            installBtn.style.display = 'none';
          }
        } else {
          // Not installed: show install button only if browser prompt fired (deferredPrompt) or keep it hidden otherwise
          if (deferredPrompt) {
            installBtn.style.display = 'inline';
          } else {
            // keep the button hidden until beforeinstallprompt fires
            installBtn.style.display = 'none';
          }
        }
      })();
    });
  })();
</script>

</body>
</html>
